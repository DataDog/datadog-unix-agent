#!/bin/sh

# Unless explicitly stated otherwise all files in this repository are licensed
# under the Apache License Version 2.0.
# This product includes software developed at Datadog (https://www.datadoghq.com/).
# Copyright 2019 Datadog, Inc.

# Perform necessary datadog-agent setup steps after package is installed.
# NOTE: for .rpm, see posttrans instead
#
# .deb: STEP 2 of 5
# .rpm: STEP 3 of 6
# .bff: STEP ? of ? (TODO)

set -e

INSTALL_DIR=/opt/datadog-agent
LOG_DIR=/var/log/datadog
CONFIG_DIR=/etc/datadog-agent
SERVICE_NAME=datadog-agent
DATADOG_USER=dd-agent
DATADOG_GROUP=dd-agent

create_datadog_user_aix()
{
    # add /usr/bin/false to the list of allowed shells
    # NOTE: this is all terrible and makes kittens cry.
    # it should all be replaced by a single, idempotent command
    set +e
    /usr/bin/lssec -f /etc/security/login.cfg -s usw -a shells | /usr/bin/grep "/usr/bin/false" > /dev/null
    RC=$?
    set -e
    if [ "${RC}" != "0" ]; then
	  SHVAL=`/usr/bin/lssec -f /etc/security/login.cfg -s usw -a shells | /usr/bin/cut -d '=' -f2`
	  /usr/bin/chsec -f /etc/security/login.cfg -s usw -a shells="${SHVAL},/usr/bin/false"
    fi

    # create the system user
    mkuser pgrp="${DATADOG_GROUP}" shell="/usr/bin/false" home="${INSTALL_DIR}" ${DATADOG_USER}
}

create_datadog_user_group()
{
    # create datadog group
    set +e
    grep "^${DATADOG_GROUP}:" /etc/group > /dev/null
    RC=$?
    set -e
    if [ "${RC}" != "0" ]; then
	  mkgroup ${DATADOG_GROUP}
    fi

    # create datadog user
    set +e
    grep "^${DATADOG_USER}:" /etc/passwd > /dev/null
    RC=$?
    set -e
    if [ "${RC}" != "0" ]; then
	  create_datadog_user_aix
    fi
}

create_system_services()
{
    # Stop subsystem if running
    set +e
    lssrc -s ${SERVICE_NAME} >/dev/null 2>&1
    RC=$?
    set -e
    if [ "${RC}" -eq 0 ] ; then
        stopsrc -s ${SERVICE_NAME} >/dev/null 2>&1 || true
        rmssys -s ${SERVICE_NAME}
    fi

    # Remove old inittab entry
    set +e
    lsitab ${SERVICE_NAME} >/dev/null 2>&1
    RC=$?
    set -e
    if [ "${RC}" -eq 0 ] ; then
        rmitab ${SERVICE_NAME}
    fi

    # Remove stale ODM subsystem definition
    odmdelete -o SRCsubsys -q "subsysname='${SERVICE_NAME}'" >/dev/null 2>&1

    # Ensure all agent processes have fully exited
    ATTEMPT=0
    MAX_ATTEMPTS=5

    while true; do
        AGENT_PIDS=$(ps -eo pid,args | grep "${INSTALL_DIR}/embedded/bin/python" | grep "${INSTALL_DIR}/agent/agent.py -m start" | grep -v grep | awk '{print $1}')

        # Exit if no processes remain
        if [ -z "${AGENT_PIDS}" ]; then
            break
        fi

        ATTEMPT=$((ATTEMPT+1))

        if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
            echo "-- Agent still running (PIDs: ${AGENT_PIDS}), sending SIGTERM (attempt $ATTEMPT/$MAX_ATTEMPTS)"
            echo "${AGENT_PIDS}" | xargs -n1 kill >/dev/null 2>&1 || true
        else
            echo "-- Agent still running after $((MAX_ATTEMPTS-1)) attempts, sending SIGKILL (kill -9)"
            echo "${AGENT_PIDS}" | xargs -n1 kill -9 >/dev/null 2>&1 || true
        fi

        sleep 5
    done

    # Create the AIX SRC subsystem for the Datadog Agent.
    #
    #   -p : Python interpreter used to run the Agent
    #   -a : Agent entrypoint (agent.py -m start)
    #   -u : Run as dd-agent user
    #   -S : Standard SRC subsystem
    #   -R : Restart automatically on abnormal exit
    #   -n : Normal stop signal (SIGTERM)
    #   -f : Forced stop signal (SIGKILL)
    #
    # Note: ODM cleanup is required beforehand to prevent stale definitions.
    mkssys \
      -s ${SERVICE_NAME} \
      -p "${INSTALL_DIR}/embedded/bin/python" \
      -a "${INSTALL_DIR}/agent/agent.py -m start" \
      -u ${DATADOG_USER} \
      -R \
      -S \
      -n 15 \
      -f 9 \
      >/dev/null

    # Start subsystem
    startsrc -s ${SERVICE_NAME} >/dev/null
}


create_datadog_user_group
create_system_services

exit 0
